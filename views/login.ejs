<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta name="viewport" content="width=1,initial-scale=1,user-scalable=1" />
	<title>Login ITSC APPs</title>
	
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="styles.css" />

</head>
<body>

	<section class="container" id="forma1" style="display: block">
			<section class="login-form">
				<form onsubmit="login(); return false;" role="login">
					<img src="/logo_itsc.png" style="max-width:100%; max-height:100%;" />
					<input type="text" id="usuario" placeholder="Usuario" required class="form-control input-lg" />
					<input type="password" id="password" placeholder="Contraseña" required class="form-control input-lg" />
					<label id="clave_mal" style="font-weight: bold; color: red; display: none">Usuario/Clave Incorrectos</label>
					<button type="submit" name="go" class="btn btn-lg btn-primary btn-block">Ingresar</button>
				</form>
				<div class="form-links">
					<a href="http://www.itsc.ec">www.itsc.ec</a>
				</div>
			</section>
	</section>

	<section class="container" id="forma2" style="display: none">
			<section class="login-form">
				<form onsubmit="login2(); return false;" role="login">
					<img src="http://www.itsc.ec/wp-content/uploads/2016/09/logo-itsc-larger.png" style="max-width:100%; max-height:100%;" />
					Grupo Empresarial <select id="ad_client_id" onchange="cambioGrupo()" required class="form-control input-lg">
					</select>
					Rol <select id="ad_role_id" onchange="cambioRol()" required class="form-control input-lg">
					</select>
					Organizaciòn <select id="ad_org_id" onchange="cambioOrg()" required class="form-control input-lg">
					</select>
					Almacèn <select id="m_warehouse_id" class="form-control input-lg">
					</select>  
					<button type="submit" name="go" class="btn btn-lg btn-primary btn-block">Ingresar</button>
				</form>
				<div class="form-links">
					<a href="http://www.itsc.ec">www.itsc.ec</a>
				</div>
			</section>
	</section>
	
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
	<script>

		var data = [];
		
		var usuario = document.getElementById('usuario')
		var clave = document.getElementById('password')

		var ad_client_id = document.getElementById('ad_client_id')
		var ad_role_id = document.getElementById('ad_role_id')
		var ad_org_id = document.getElementById('ad_org_id')
		var m_warehouse_id = document.getElementById('m_warehouse_id')

		async function login () {
			try {
				document.body.style.pointerEvents = "none" //Bloquea todo click hasta que se carge la pagina
				
				var res = await fetch('/login', {
					method: 'POST',
					headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({usuario: usuario.value, clave: clave.value})
				})

				if (res.ok) {
					data = JSON.parse(await res.text()) 
					console.log(data)

					document.getElementById("forma1").style.display= "none"
					document.getElementById("forma2").style.display= "block"

					updateSelect(ad_client_id, cargarClientes());

				} else {
					alert("Usuario/Clave Incorrectos")
					document.getElementById('clave_mal').style.display = 'block'
				}
			} catch (e) {
				alert("Ha ocurrido un error!")
				console.log("Error", e)
			} finally {
				document.body.style.pointerEvents = "all"
			}			
		}
		
		async function login2 () {
			try {
				document.body.style.pointerEvents = "none" //Bloquea todo click hasta que se carge la pagina
				
				var res = await fetch('/login/datos', {
					method: 'POST',
					headers: {
						'Accept': 'application/json',
						'Content-Type': 'application/json'
					},
					body: JSON.stringify({
						usuario: usuario.value, 
						clave: clave.value,
						ad_client_id: ad_client_id.value,
						ad_org_id: ad_org_id.value,
						ad_role_id: ad_role_id.value,
						m_warehouse_id: m_warehouse_id.value
					})
				})
				var msg = await res.text()
				if (res.ok) {
					window.location.replace(`/login/token/${encodeURIComponent(msg)}`) 

				} else {
					alert(msg)
					console.log(res, msg)
				}
			} catch (e) {
				alert("Error:" + e.message)
				console.log("Error", e)
			} finally {
				document.body.style.pointerEvents = "all"
			}
		}
		
		function updateSelect (select, data, flag) {
			data = data.filter(rec => rec.value !== '')
			while (select.options.length > 0)                
				select.remove(0);
			
			if (!flag) {
				var option = document.createElement('option')
				option.value = ""
				option.text = "Ingrese una opciòn";
				option.selected = true;
				option.disabled = true;	
				select.add(option) 
			}

			for (var rec of data) {
				var option = document.createElement('option')
				option.value = rec.value;
				option.text = rec.text;
				select.add(option) 
			}			       
		}

		function cargarClientes () {
			var temp = data.map(rec => `${rec.ad_client_id}////${rec.grupo}`)
			temp = [...new Set(temp)]
			temp = temp.map(r => r.split('////'))
			return temp.map(r => {
				return { value: r[0], text: r[1] }
			})
		}

		function cambioGrupo () {
			var temp = data.filter(rec => rec.ad_client_id === ad_client_id.value)

			temp = temp.map(rec => `${rec.ad_role_id}////${rec.rol}`)
			temp = [...new Set(temp)]
			temp = temp.map(r => r.split('////'))
			temp = temp.map(r => {
				return { value: r[0], text: r[1] }
			})

			updateSelect(ad_role_id, temp)
			updateSelect(ad_org_id, [], true)
			updateSelect(m_warehouse_id, [], true)
		}

		function cambioRol () {
			var temp = data.filter(rec => rec.ad_client_id === ad_client_id.value && rec.ad_role_id === ad_role_id.value)

			temp = temp.map(rec => `${rec.ad_org_id || ''}////${rec.organizacion || ''}`)
			temp = [...new Set(temp)]
			temp = temp.map(r => r.split('////'))
			temp = temp.map(r => {
				return { value: r[0], text: r[1] }
			})

			updateSelect(ad_org_id, temp)
			updateSelect(m_warehouse_id, [], true)
		}

		function cambioOrg () {
			var temp = data.filter(rec => rec.ad_client_id === ad_client_id.value && rec.ad_role_id === ad_role_id.value && rec.ad_org_id === ad_org_id.value)

			temp = temp.map(rec => `${rec.m_warehouse_id || ''}////${rec.warehouse || ''}`)
			temp = [...new Set(temp)]
			temp = temp.map(r => r.split('////'))
			temp = temp.map(r => {
				return { value: r[0], text: r[1] }
			})

			updateSelect(m_warehouse_id, temp)
		}
		
	</script>
</body>
</html>